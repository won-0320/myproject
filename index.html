<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>리그전 점수 관리 (최종)</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#f6f8fb;--card:#fff;--accent:#2563eb;--muted:#6b7280}
*{box-sizing:border-box}
body{font-family:'Noto Sans KR',system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:#111;margin:0}
header{background:linear-gradient(90deg,#06b6d4,#2563eb);color:#fff;padding:18px}
.wrap{max-width:1150px;margin:18px auto;padding:12px}
.grid{display:grid;grid-template-columns:1fr 420px;gap:16px}
.card{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 2px 8px rgba(16,24,40,0.06)}
label{display:block;margin:8px 0 4px;font-weight:600}
select,input,button,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #e6edf3}
.btn{display:inline-block;padding:8px 10px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer}
.btn-ghost{background:transparent;border:1px solid #ddd;color:#111;cursor:pointer}
.small{font-size:0.9rem;color:var(--muted)}
table{width:100%;border-collapse:collapse;margin-top:8px;font-size:0.9rem}
th,td{padding:6px;border:1px solid #eef2f6;text-align:center}
thead th{background:#fafafa}
.responsive{overflow:auto}
.modal{display:none;position:fixed;z-index:9999;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.4);justify-content:center;align-items:center}
.modal .modal-content{background:#fff;padding:18px;border-radius:10px;min-width:280px}
@media (max-width:920px){ .grid{grid-template-columns:1fr} .card{margin-bottom:12px} }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1 style="margin:0;font-size:1.1rem">리그전 점수 관리 — 통합판</h1>
    <div class="small" style="margin-top:6px">8반(반별 학생수 조절), 학생번호/이름 입력, 학생별 비밀번호 생성/변경, 교사 관리, CSV/PDF, 로컬 저장</div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <section>
      <div class="card">
        <h2>학생 입력</h2>
        <div class="small">반/학생 선택 후 학생 비밀번호(없으면 새로 설정) 입력하고 5게임 결과를 저장하세요.</div>

        <label>반 선택</label>
        <select id="inputClassSelect"></select>

        <div style="display:flex;gap:8px;margin-top:8px">
          <div style="flex:1">
            <label>학생 선택</label>
            <select id="studentSelectForInput"></select>
          </div>
          <div style="width:160px">
            <label>학생 수 (1~20)</label>
            <input id="studentCountInput" type="number" min="1" max="20"/>
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="applyStudentCountBtn" class="btn">학생수 적용</button>
          <button id="autoFillNamesBtn" class="btn-ghost">자동 채우기</button>
          <button id="clearClassBtn" class="btn-ghost">반 초기화</button>
        </div>

        <div style="margin-top:10px">
          <label>학생 비밀번호 (현재 비밀번호 입력 또는 새 비밀번호 입력)</label>
          <input id="studentPasswordInput" type="password" placeholder="비밀번호 입력 (첫 사용 시 새 비밀번호로 설정)"/>
        </div>

        <div id="gameInputsWrap" style="margin-top:10px"></div>

        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="saveStudentResultBtn" class="btn">저장</button>
          <button id="changeStudentPwBtn" class="btn-ghost">비밀번호 변경</button>
          <button id="deleteStudentBtn" class="btn-ghost">학생 삭제</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h2>데이터 관리</h2>
        <div class="small">데이터를 로컬에 저장/불러오기, 내보내기, 전체 초기화</div>
        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
          <button id="saveAllBtn" class="btn">로컬에 저장</button>
          <button id="loadAllBtn" class="btn-ghost">로컬 불러오기</button>
          <button id="exportCsvBtn" class="btn">CSV 내보내기</button>
          <button id="exportPdfBtn" class="btn">PDF 내보내기</button>
          <button id="resetAllBtn" class="btn-ghost">초기화 (전체)</button>
        </div>
      </div>
    </section>

    <aside>
      <div class="card">
        <h2>요약 & 교사 기능</h2>
        <div class="small">교사 로그인(비밀번호 변경 가능) 후 학생정보 편집/비밀번호 초기화/다운로드 등을 할 수 있습니다.</div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="openTeacherLoginBtn" class="btn">교사 로그인</button>
          <button id="calcAllBtn" class="btn-ghost">승점 계산</button>
          <button id="refreshViewBtn" class="btn-ghost">뷰 새로고침</button>
        </div>

        <div id="teacherArea" class="teacher-only" style="display:none;margin-top:12px">
          <h3>교사 전용 기능</h3>

          <div style="margin-top:8px">
            <h4>학생 정보 편집 (번호 / 이름)</h4>
            <label>반 선택</label>
            <select id="editClassSelect"></select>
            <label>학생 선택</label>
            <select id="editStudentSelect"></select>
            <div style="display:flex;gap:8px;margin-top:8px">
              <input id="editStudentId" type="number" min="1" placeholder="번호"/>
              <input id="editStudentName" type="text" placeholder="이름"/>
            </div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="saveStudentInfoBtn" class="btn">저장</button>
              <button id="resetStudentPwdBtn" class="btn-ghost">비밀번호 초기화(기본)</button>
              <button id="setStudentPwdBtn" class="btn-ghost">비밀번호 직접설정</button>
            </div>
          </div>

          <div style="margin-top:12px">
            <h4>교사 비밀번호 변경</h4>
            <input id="newTeacherPw" type="password" placeholder="새 비밀번호 입력"/>
            <button id="changeTeacherPwBtn" class="btn" style="margin-top:8px">변경</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h2>결과 확인</h2>
        <div class="small">모든 반의 학생 결과를 반별로 순위 정렬하여 보여줍니다.</div>
        <div id="resultsWrap" class="responsive" style="margin-top:10px;max-height:560px;overflow:auto"></div>
      </div>
    </aside>
  </div>
</main>

<!-- 교사 로그인 모달 -->
<div id="teacherLoginModal" class="modal"><div class="modal-content">
  <h3>교사 인증</h3>
  <input id="teacherPasswordInput" type="password" placeholder="교사 비밀번호 입력"/>
  <div style="display:flex;gap:8px;margin-top:10px;justify-content:center">
    <button id="teacherLoginOkBtn" class="btn">확인</button>
    <button id="teacherLoginCancelBtn" class="btn-ghost">취소</button>
  </div>
</div></div>

<!-- 직접 비밀번호 설정 모달 (교사용: 학생 비밀번호 직접 설정) -->
<div id="customPwdModal" class="modal"><div class="modal-content">
  <h3>학생 비밀번호 직접설정</h3>
  <div id="customPwdInfo" class="small" style="margin-bottom:8px"></div>
  <input id="customPwdInput" type="text" placeholder="새 비밀번호 입력"/>
  <div style="display:flex;gap:8px;margin-top:10px;justify-content:center">
    <button id="customPwdOkBtn" class="btn">설정</button>
    <button id="customPwdCancelBtn" class="btn-ghost">취소</button>
  </div>
</div></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
/* ====== 설정 ====== */
const SCORE = { '승':3, '패':2, '불참':0 };
const LS_KEY = 'league_scores_final_v1';
let teacherMode = false;
let TEACHER_PASSWORD = localStorage.getItem('teacherPassword') || 'teacher123';
let classes = [];

/* ====== 데이터 초기화 / 로드 / 저장 ====== */
function initClasses(){
  classes = [];
  for(let c=1;c<=8;c++){
    const students = [];
    for(let i=0;i<20;i++){
      students.push({
        id: i+1,
        name: `학생${i+1}`,
        results: ['불참','불참','불참','불참','불참'],
        total: 0,
        password: '', // 빈 문자열: 비밀번호 없음 (학생이 직접 설정)
        lastSaved: null
      });
    }
    classes.push({ name: `반${c}`, students });
  }
  saveLocal();
}
function loadLocal(){
  const raw = localStorage.getItem(LS_KEY);
  if(raw){
    try { classes = JSON.parse(raw); } catch(e){ initClasses(); }
  } else { initClasses(); }
}
function saveLocal(){ localStorage.setItem(LS_KEY, JSON.stringify(classes)); }

/* 초기 로드 */
loadLocal();

/* ====== UI 엘리먼트 ====== */
const inputClassSelect = document.getElementById('inputClassSelect');
const studentSelectForInput = document.getElementById('studentSelectForInput');
const studentCountInput = document.getElementById('studentCountInput');
const gameInputsWrap = document.getElementById('gameInputsWrap');
const resultsWrap = document.getElementById('resultsWrap');

/* ====== 렌더 반/학생 선택 ====== */
function renderClassSelectors(){
  inputClassSelect.innerHTML = classes.map((c,i)=>`<option value="${i}">${escapeHtml(c.name)}</option>`).join('');
  const idx = Number(inputClassSelect.value || 0);
  populateStudentSelect(idx);
  studentCountInput.value = classes[idx].students.length;
}
function populateStudentSelect(classIdx){
  const students = classes[classIdx].students;
  studentSelectForInput.innerHTML = students.map((s,i)=>`<option value="${i}">${escapeHtml(String(s.id))+'. '+escapeHtml(s.name)}</option>`).join('');
}

/* ====== 학생수 적용 (반별) ====== */
function applyStudentCount(){
  const classIdx = Number(inputClassSelect.value || 0);
  let count = Number(studentCountInput.value) || 1;
  if(count < 1) count = 1;
  if(count > 20) count = 20;
  const students = classes[classIdx].students;
  if(count > students.length){
    for(let i=students.length;i<count;i++){
      students.push({ id:i+1, name:`학생${i+1}`, results:['불참','불참','불참','불참','불참'], total:0, password:'', lastSaved:null });
    }
  } else if(count < students.length){
    students.splice(count);
  }
  saveLocal();
  populateStudentSelect(classIdx);
  updateGameInputs(classIdx, 0);
  renderSummary();
}

/* 자동 채우기 */
function autoFillNames(){
  const classIdx = Number(inputClassSelect.value || 0);
  const count = classes[classIdx].students.length;
  classes[classIdx].students = Array.from({length:count},(_,i)=>({
    id:i+1, name:`학생${i+1}`, results:['불참','불참','불참','불참','불참'], total:0, password:'', lastSaved:null
  }));
  saveLocal();
  populateStudentSelect(classIdx);
  updateGameInputs(classIdx,0);
  renderSummary();
}

/* 반 초기화 (선택 반) */
function clearClass(){
  if(!confirm('선택한 반을 초기화합니까?')) return;
  const classIdx = Number(inputClassSelect.value || 0);
  const size = Number(studentCountInput.value) || 1;
  classes[classIdx].students = Array.from({length:size},(_,i)=>({
    id:i+1, name:`학생${i+1}`, results:['불참','불참','불참','불참','불참'], total:0, password:'', lastSaved:null
  }));
  saveLocal();
  populateStudentSelect(classIdx);
  updateGameInputs(classIdx,0);
  renderSummary();
}

/* 학생 삭제 */
function deleteStudent(){
  const classIdx = Number(inputClassSelect.value || 0);
  const stuIdx = Number(studentSelectForInput.value || 0);
  if(!confirm('선택한 학생을 삭제합니까?')) return;
  classes[classIdx].students.splice(stuIdx,1);
  // 재부여 id 순서 (옵션) — 여기서는 남아있는 순서대로 id 재설정
  classes[classIdx].students.forEach((s,i)=> s.id = i+1);
  saveLocal();
  populateStudentSelect(classIdx);
  updateGameInputs(classIdx, Math.max(0, stuIdx-1));
  studentCountInput.value = classes[classIdx].students.length;
  renderSummary();
}

/* ====== 게임 입력 UI ====== */
function updateGameInputs(classIdx, stuIdx){
  const student = classes[classIdx].students[stuIdx];
  gameInputsWrap.innerHTML = '';
  for(let i=0;i<5;i++){
    const lbl = document.createElement('label'); lbl.textContent = `게임 ${i+1}`;
    const sel = document.createElement('select'); sel.id = `game${i}`;
    ['승','패','불참'].forEach(opt=>{
      const o = document.createElement('option'); o.value = opt; o.textContent = opt;
      if(student.results[i] === opt) o.selected = true;
      sel.appendChild(o);
    });
    gameInputsWrap.appendChild(lbl);
    gameInputsWrap.appendChild(sel);
  }
  const totalDiv = document.createElement('div'); totalDiv.id = 'studentTotalPreview'; totalDiv.style.marginTop = '8px';
  gameInputsWrap.appendChild(totalDiv);
  gameInputsWrap.querySelectorAll('select').forEach(s=>s.addEventListener('change', updateStudentTotalPreview));
  updateStudentTotalPreview();
}
function updateStudentTotalPreview(){
  const selects = gameInputsWrap.querySelectorAll('select');
  let total = 0;
  selects.forEach(s=> total += SCORE[s.value] || 0);
  const div = document.getElementById('studentTotalPreview');
  if(div) div.textContent = `현재 합계: ${total}점`;
}

/* ====== 학생 결과 저장 (학생이 비밀번호 없으면 새 비밀번호로 설정) ====== */
document.getElementById('saveStudentResultBtn').addEventListener('click', ()=>{
  const classIdx = Number(inputClassSelect.value || 0);
  const stuIdx = Number(studentSelectForInput.value || 0);
  const pwInput = (document.getElementById('studentPasswordInput').value || '').trim();
  const student = classes[classIdx].students[stuIdx];

  if(student.password === ''){
    // 비밀번호가 없으면 첫 사용 시 새 비밀번호로 설정 요구
    if(!pwInput){
      alert('이 학생은 비밀번호가 설정되어 있지 않습니다. 먼저 비밀번호를 입력하여 설정하세요.');
      return;
    }
    student.password = pwInput;
    alert(`${student.name} 학생의 비밀번호가 새로 설정되었습니다.`);
  } else {
    if(!teacherMode && pwInput !== student.password){
      alert('비밀번호가 틀렸습니다.');
      return;
    }
  }

  // 경기 결과 저장
  const results = [];
  for(let i=0;i<5;i++){
    const sel = document.getElementById(`game${i}`);
    results.push(sel? sel.value : '불참');
  }
  student.results = results;
  student.total = results.reduce((acc,v)=>acc + (SCORE[v]||0), 0);
  student.lastSaved = new Date().toISOString();
  saveLocal();
  renderSummary();
  alert('저장되었습니다.');
});

/* ====== 학생 비밀번호 변경 (학생 자신) ====== */
document.getElementById('changeStudentPwBtn').addEventListener('click', ()=>{
  const classIdx = Number(inputClassSelect.value || 0);
  const stuIdx = Number(studentSelectForInput.value || 0);
  const current = (document.getElementById('studentPasswordInput').value || '').trim();
  const newPw = prompt('새 비밀번호를 입력하세요 (공백이면 취소):');
  if(newPw === null) return;
  const student = classes[classIdx].students[stuIdx];
  if(student.password === ''){
    alert('비밀번호가 설정되어 있지 않습니다. 먼저 저장을 통해 비밀번호를 생성하세요.');
    return;
  }
  if(current !== student.password && !teacherMode){ alert('현재 비밀번호가 올바르지 않습니다.'); return; }
  if(!newPw.trim()){ alert('새 비밀번호가 비어 있습니다.'); return; }
  student.password = newPw.trim();
  saveLocal();
  alert('비밀번호가 변경되었습니다.');
});

/* ====== 교사 모드 ====== */
const openTeacherLoginBtn = document.getElementById('openTeacherLoginBtn');
const teacherLoginModal = document.getElementById('teacherLoginModal');
openTeacherLoginBtn.addEventListener('click', ()=> teacherLoginModal.style.display = 'flex');
document.getElementById('teacherLoginCancelBtn').addEventListener('click', ()=> teacherLoginModal.style.display = 'none');
document.getElementById('teacherLoginOkBtn').addEventListener('click', ()=>{
  const v = (document.getElementById('teacherPasswordInput').value || '').trim();
  if(v === TEACHER_PASSWORD){
    teacherMode = true;
    teacherLoginModal.style.display = 'none';
    document.getElementById('teacherArea').style.display = 'block';
    populateEditSelectors();
    alert('교사 인증 성공 — 교사 모드 활성화');
  } else {
    alert('교사 비밀번호가 틀렸습니다.');
  }
});

/* 교사 비밀번호 변경 */
document.getElementById('changeTeacherPwBtn').addEventListener('click', ()=>{
  if(!teacherMode){ alert('교사로 로그인해야 합니다.'); return; }
  const newPw = (document.getElementById('newTeacherPw').value || '').trim();
  if(!newPw){ alert('새 비밀번호를 입력하세요.'); return; }
  TEACHER_PASSWORD = newPw;
  localStorage.setItem('teacherPassword', newPw);
  document.getElementById('newTeacherPw').value = '';
  alert('교사 비밀번호가 변경되었습니다.');
});

/* ====== 교사: 학생 정보 편집(번호/이름) ====== */
function populateEditSelectors(){
  const editClassSelect = document.getElementById('editClassSelect');
  const editStudentSelect = document.getElementById('editStudentSelect');
  editClassSelect.innerHTML = classes.map((c,i)=>`<option value="${i}">${escapeHtml(c.name)}</option>`).join('');
  const idx = Number(editClassSelect.value || 0);
  editStudentSelect.innerHTML = classes[idx].students.map((s,i)=>`<option value="${i}">${escapeHtml(String(s.id))+'. '+escapeHtml(s.name)}</option>`).join('');
  loadStudentInfoToEdit(idx, 0);

  editClassSelect.addEventListener('change', ()=>{
    const ci = Number(editClassSelect.value || 0);
    editStudentSelect.innerHTML = classes[ci].students.map((s,i)=>`<option value="${i}">${escapeHtml(String(s.id))+'. '+escapeHtml(s.name)}</option>`).join('');
    loadStudentInfoToEdit(ci, 0);
  });
  editStudentSelect.addEventListener('change', ()=>{
    const ci = Number(editClassSelect.value || 0);
    const si = Number(editStudentSelect.value || 0);
    loadStudentInfoToEdit(ci, si);
  });
}
function loadStudentInfoToEdit(classIdx, stuIdx){
  const s = classes[classIdx].students[stuIdx];
  document.getElementById('editStudentId').value = s.id;
  document.getElementById('editStudentName').value = s.name;
}
document.getElementById('saveStudentInfoBtn').addEventListener('click', ()=>{
  if(!teacherMode){ alert('교사로 로그인해야 합니다.'); return; }
  const classIdx = Number(document.getElementById('editClassSelect').value || 0);
  const stuIdx = Number(document.getElementById('editStudentSelect').value || 0);
  const id = Number(document.getElementById('editStudentId').value) || (stuIdx+1);
  const name = (document.getElementById('editStudentName').value || '').trim();
  if(!name){ alert('이름을 입력하세요.'); return; }
  classes[classIdx].students[stuIdx].id = id;
  classes[classIdx].students[stuIdx].name = name;
  saveLocal();
  populateStudentSelect(Number(inputClassSelect.value || 0));
  populateEditSelectors();
  renderSummary();
  alert('학생 정보가 저장되었습니다.');
});

/* 교사: 비밀번호 초기화 (기본값 stu번호) */
document.getElementById('resetStudentPwdBtn').addEventListener('click', ()=>{
  if(!teacherMode){ alert('교사로 로그인해야 합니다.'); return; }
  const classIdx = Number(document.getElementById('editClassSelect').value || 0);
  const stuIdx = Number(document.getElementById('editStudentSelect').value || 0);
  const student = classes[classIdx].students[stuIdx];
  const newPw = 'stu' + (student.id || (stuIdx+1));
  if(!confirm(`${student.name}의 비밀번호를 ${newPw} 로 초기화하시겠습니까?`)) return;
  student.password = newPw;
  saveLocal();
  alert(`${student.name} 비밀번호가 초기화되었습니다. 새 비밀번호: ${newPw}`);
});

/* 교사: 학생 비밀번호 직접 설정 (모달) */
const customPwdModal = document.getElementById('customPwdModal');
document.getElementById('setStudentPwdBtn').addEventListener('click', ()=>{
  if(!teacherMode){ alert('교사로 로그인해야 합니다.'); return; }
  const classIdx = Number(document.getElementById('editClassSelect').value || 0);
  const stuIdx = Number(document.getElementById('editStudentSelect').value || 0);
  const student = classes[classIdx].students[stuIdx];
  document.getElementById('customPwdInfo').textContent = `${student.name} 의 비밀번호를 설정합니다.`;
  document.getElementById('customPwdInput').value = '';
  customPwdModal.style.display = 'flex';
});
document.getElementById('customPwdCancelBtn').addEventListener('click', ()=> customPwdModal.style.display='none');
document.getElementById('customPwdOkBtn').addEventListener('click', ()=>{
  const classIdx = Number(document.getElementById('editClassSelect').value || 0);
  const stuIdx = Number(document.getElementById('editStudentSelect').value || 0);
  const newPw = (document.getElementById('customPwdInput').value || '').trim();
  if(!newPw){ alert('비밀번호를 입력하세요.'); return; }
  classes[classIdx].students[stuIdx].password = newPw;
  saveLocal();
  customPwdModal.style.display = 'none';
  alert('비밀번호가 설정되었습니다.');
});

/* ====== 계산 / 정렬 / 표시 ====== */
function calculateAll(){
  classes.forEach(c=>{
    c.students.forEach(s=>{
      s.total = (s.results || ['불참','불참','불참','불참','불참']).reduce((acc,v)=>acc + (SCORE[v]||0), 0);
    });
  });
  saveLocal();
  renderSummary();
  alert('승점 계산 완료');
}

function renderSummary(){
  let html = '';
  classes.forEach((c,ci)=>{
    const sorted = c.students.map((s,idx)=>({...s, _idx:idx})).sort((a,b)=> (b.total||0) - (a.total||0));
    html += `<div style="margin-bottom:14px"><h4 style="margin:6px 0">${escapeHtml(c.name)} — 인원 ${c.students.length}</h4>`;
    html += `<div style="overflow:auto"><table><thead><tr><th>순위</th><th>번호</th><th>이름</th><th>G1</th><th>G2</th><th>G3</th><th>G4</th><th>G5</th><th>총점</th></tr></thead><tbody>`;
    sorted.forEach((s,i)=>{
      html += `<tr><td>${i+1}</td><td>${escapeHtml(String(s.id))}</td><td>${escapeHtml(s.name)}</td>`;
      for(let k=0;k<5;k++) html += `<td>${s.results && s.results[k] ? s.results[k] : '불참'}</td>`;
      html += `<td>${s.total || 0}</td></tr>`;
    });
    html += `</tbody></table></div></div>`;
  });

  // 전체 리스트
  html += `<div style="margin-top:8px"><h4 style="margin:6px 0">전체 학생 목록</h4><div style="overflow:auto"><table><thead><tr><th>반</th><th>번호</th><th>이름</th><th>G1</th><th>G2</th><th>G3</th><th>G4</th><th>G5</th><th>총점</th></tr></thead><tbody>`;
  classes.forEach(c=>{
    c.students.forEach(s=>{
      html += `<tr><td>${escapeHtml(c.name)}</td><td>${escapeHtml(String(s.id))}</td><td>${escapeHtml(s.name)}</td>${(s.results||['','','','','']).map(r=>`<td>${r}</td>`).join('')}<td>${s.total||0}</td></tr>`;
    });
  });
  html += `</tbody></table></div></div>`;

  resultsWrap.innerHTML = html;
}

/* ====== export CSV / PDF ====== */
function exportCSV(){
  const rows = [['반','번호','이름','게임1','게임2','게임3','게임4','게임5','총점']];
  classes.forEach(c=>{
    c.students.forEach(s=>{
      rows.push([c.name, s.id, s.name, ...(s.results||['불참','불참','불참','불참','불참']), s.total||0]);
    });
  });
  const csv = rows.map(r=> r.map(cell=> `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'league_scores_export.csv'; a.click(); URL.revokeObjectURL(url);
}

function exportPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt', format:'a4'});
  const margin = 40; let y = 40; const lineHeight = 12;
  doc.setFontSize(12); doc.text('리그전 승점 결과', margin, y); y += 18;
  classes.forEach(c=>{
    doc.setFontSize(10); doc.text(`${c.name} (인원 ${c.students.length})`, margin, y); y += 14;
    doc.setFontSize(9);
    const headers = ['순','번호','이름','G1','G2','G3','G4','G5','총'];
    doc.text(headers.join(' | '), margin, y); y += lineHeight;
    const sorted = c.students.map((s,i)=>({...s, idx:i})).sort((a,b)=> (b.total||0) - (a.total||0));
    sorted.forEach((s,si)=>{
      const row = [String(si+1), s.id, s.name, ...(s.results||['','','','','']), String(s.total||0)];
      doc.text(row.join(' | '), margin, y); y += lineHeight;
      if(y > doc.internal.pageSize.height - margin){ doc.addPage(); y = margin; }
    });
    y += 8;
    if(y > doc.internal.pageSize.height - margin){ doc.addPage(); y = margin; }
  });
  doc.save('league_scores.pdf');
}

/* ====== 전체 초기화 ====== */
function resetAll(){
  if(!confirm('정말로 모든 데이터를 초기화합니까? (복구 불가)')) return;
  initClasses();
  TEACHER_PASSWORD = 'teacher123';
  localStorage.removeItem('teacherPassword');
  saveLocal();
  renderClassSelectors();
  renderSummary();
  alert('초기화 완료. 교사 비밀번호는 "teacher123"으로 복원되었습니다.');
}

/* ====== 헬퍼 ====== */
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ====== 이벤트 바인딩 & 초기 렌더 ====== */
document.getElementById('applyStudentCountBtn').addEventListener('click', applyStudentCount);
document.getElementById('autoFillNamesBtn').addEventListener('click', autoFillNames);
document.getElementById('clearClassBtn').addEventListener('click', clearClass);
document.getElementById('deleteStudentBtn').addEventListener('click', deleteStudent);
document.getElementById('saveAllBtn').addEventListener('click', ()=>{ saveLocal(); alert('로컬에 저장되었습니다.'); });
document.getElementById('loadAllBtn').addEventListener('click', ()=>{ loadLocal(); renderClassSelectors(); renderSummary(); alert('로컬에서 불러왔습니다.'); });
document.getElementById('exportCsvBtn').addEventListener('click', exportCSV);
document.getElementById('exportPdfBtn').addEventListener('click', exportPDF);
document.getElementById('resetAllBtn').addEventListener('click', resetAll);
document.getElementById('calcAllBtn').addEventListener('click', calculateAll);
document.getElementById('refreshViewBtn').addEventListener('click', renderSummary);

/* inputClass / student select 변경 처리 */
inputClassSelect.addEventListener('change', ()=>{
  const idx = Number(inputClassSelect.value || 0);
  populateStudentSelect(idx);
  studentCountInput.value = classes[idx].students.length;
  updateGameInputs(idx, 0);
});
studentSelectForInput.addEventListener('change', ()=> updateGameInputs(Number(inputClassSelect.value || 0), Number(studentSelectForInput.value || 0)));

/* teacher area: edit selectors */
document.getElementById('editClassSelect').addEventListener('change', ()=> populateEditSelectors());
document.getElementById('editStudentSelect').addEventListener('change', ()=> populateEditSelectors());

/* custom pwd modal buttons already wired above */
document.getElementById('customPwdCancelBtn').addEventListener('click', ()=> customPwdModal.style.display = 'none');

/* 페이지 초기화 렌더 */
function renderClassSelectors(){ inputClassSelect.innerHTML = classes.map((c,i)=>`<option value="${i}">${escapeHtml(c.name)}</option>`).join(''); const idx = Number(inputClassSelect.value || 0); populateStudentSelect(idx); studentCountInput.value = classes[idx].students.length; updateGameInputs(idx, Number(studentSelectForInput.value || 0)); populateEditSelectors(); }
renderClassSelectors();
renderSummary();

</script>
</body>
</html>